---
title: "Sexual Identity Change, SPHC 2014 Followed Up Until 2021"
author: "Willi Zhang, Shaun Seaman, Sean McGrath, Ilya Shpitser, Maya Mathur"
email: willi.zhang@ki.se
output:
  html_document:
    self_contained: true
    toc: true
    number_sections: true
    df_print: paged
    theme: cosmo
editor_options:
  chunk_output_type: console
---

### 1. Load Packages
```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(tidyverse)
library(naniar)
library(haven)
library(finalfit)
library(survey)
library(iai)
library(mice)
library(mitools)
```

### 2. SPHC 2014, followed up to 2021
```{r}
load('/Volumes/projects/LGBT Project data/d_2014.RData')

# sexual identity in 2014
table( d_2014$F14U90G82, useNA = "always" )
d_2014$sexual_identity_2014 <- factor( ifelse( d_2014$F14U90G82 == 1, "Heterosexual", "Non-heterosexual" ),
                                       levels = c( "Heterosexual", "Non-heterosexual" ) )
table( d_2014$sexual_identity_2014, useNA = "always" )

# sexual identity in 2021
table( d_2014$F21F91, useNA = "always" )
d_2014$sexual_identity_2021 <- factor( ifelse( d_2014$F21F91 == 1, "Heterosexual", "Non-heterosexual" ),
                                       levels = c( "Heterosexual", "Non-heterosexual" ) )
table( d_2014$sexual_identity_2021, useNA = "always" )

# change in sexual identity
d_2014$identity_change <- ifelse( d_2014$sexual_identity_2014 == d_2014$sexual_identity_2021, 0, 1 )
table( d_2014$identity_change, useNA = "always" )

# sex
table( d_2014$kon, useNA = "always" )
d_2014$sex <- factor( ifelse( d_2014$kon == 1, "Male", "Female" ),
                      levels = c( "Male", "Female" ) )
table( d_2014$sex, useNA = "always" )

# age
summary( d_2014$F14alder )
d_2014$age <- d_2014$F14alder
d_2014$age_group <- cut( d_2014$age,
                         breaks = c( min( d_2014$age ), 20, 25, 30, 35, 40, 45, 50, 55, 60, 65, 70, max( d_2014$age ) ),
                         right = FALSE,
                         include.lowest = TRUE )
table( d_2014$age_group )

# country of birth
table( d_2014$fodelseland, useNA = "always" )
d_2014$country_of_birth <- factor( ifelse( d_2014$fodelseland == "Sverige", "Sweden",
                                           ifelse( d_2014$fodelseland == "Europa", "Europe", "Outside Europe" ) ),
                                   levels = c( "Sweden", "Europe", "Outside Europe" ) )
table( d_2014$country_of_birth, useNA = "always" )

# occupation
table( d_2014$SSYK_kl, useNA = "always" )
d_2014$occupation <- factor(
  ifelse(
    d_2014$SSYK_kl == "Yrken inom byggverksamhet och tillverkning" |
      d_2014$SSYK_kl == "Yrken inom lantbruk, trädgård, skogsbruk och fiske" |
      d_2014$SSYK_kl == "Yrken inom maskinell tillverkning och transport m.m.",
    "Manual and field trades",
    ifelse(
      d_2014$SSYK_kl == "Service-, omsorgs- och försäljningsyrken" |
        d_2014$SSYK_kl == "Yrken inom administration och kundtjänst" |
        d_2014$SSYK_kl == "Yrken med krav på kortare utbildning eller introduktion",
      "Service and support",
      ifelse(
        d_2014$SSYK_kl == "Yrken med krav på fördjupad högskolekompetens" |
          d_2014$SSYK_kl == "Yrken med krav på högskolekompetens eller motsvarande" |
          d_2014$SSYK_kl == "Chefsyrken" |
          d_2014$SSYK_kl == "Militära yrken",
        "Expertise and leadership",
        NA
      )
    )
  ),
  levels = c(
    "Manual and field trades",
    "Service and support",
    "Expertise and leadership"
  )
)
table( d_2014$occupation, useNA = "always" )

# association of age and occupation
ggplot( d_2014 %>%
          filter( !is.na( occupation ) ),
        aes( x = age_group, fill = occupation ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs(
    x = "Age Group",
    y = "Percentage",
    fill = "Occupation" ) +
  theme_classic()

ggplot( d_2014,
        aes( x = age_group, fill = is.na( occupation ) ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs(
    x = "Age Group",
    y = "Percentage",
    fill = "Missingness of Occupation" ) +
  theme_classic()

# association of age and identity change
ggplot( d_2014 %>%
          filter( !is.na( identity_change ) ) %>%
          mutate( identity_change = as.factor( ifelse( identity_change == 1, "Yes", "No" ) ) ),
        aes( x = age_group, fill = identity_change ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs(
    x = "Age Group",
    y = "Percentage",
    fill = "Identity Change" ) +
  theme_classic()

ggplot( d_2014,
        aes( x = age_group, fill = is.na( identity_change ) ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs(
    x = "Age Group",
    y = "Percentage",
    fill = "Missingness of Identity Change" ) +
  theme_classic()


# define study sample
prop_miss( d_2014$sexual_identity_2014 )

d_2014_selected <- d_2014 %>% 
  select( "sexual_identity_2014", "sexual_identity_2021", "identity_change", "age", "sex", "country_of_birth", "occupation" ) %>%
  filter( age >= 25,
          age <= 60,
          !is.na( sexual_identity_2014 ) # remove missingness in sexual_identity_2014 
          )
summary( d_2014_selected )
nrow( d_2014_selected ) # 11,274
miss_var_summary( d_2014_selected )

# characteristics table
explanatory =  c( "age", "sex", "country_of_birth", "occupation", "sexual_identity_2014", "sexual_identity_2021" )
dependent = "identity_change"

d_2014_table <- d_2014_selected %>%
  mutate( identity_change = as.factor( ifelse( identity_change == 1, "Yes", "No" ) ) ) %>%
  summary_factorlist( dependent,
                      explanatory, 
                      na_include = TRUE,
                      na_include_dependent = TRUE, 
                      total_col = TRUE,
                      add_col_totals = TRUE,
                      column = TRUE )

d_2014_table

# correlation of sexual identity in 2014 and occupation
ggplot( d_2014_selected %>%
          filter( !is.na( occupation ) ),
        aes( x = sexual_identity_2014, fill = occupation ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs( x = "Sexual Identity in 2014", y = "Percentage", fill = "Occupation" ) +
  theme_classic()

ggplot( d_2014_selected,
        aes( x = sexual_identity_2014, fill = is.na( occupation ) ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs( x = "Sexual Identity in 2014", y = "Percentage", fill = "Missingness of Occupation" ) +
  theme_classic()

# correlation of sexual identity in 2014 and identity change
ggplot( d_2014_selected %>% 
          filter( !is.na( identity_change ) ) %>%
          mutate( identity_change = as.factor( ifelse( identity_change == 1, "Yes", "No" ) ) ),
        aes( x = sexual_identity_2014, fill = identity_change ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs( x = "Sexual Identity in 2014", y = "Percentage", fill = "Identity Change" ) +
  theme_classic()

ggplot( d_2014_selected,
        aes( x = sexual_identity_2014, fill = is.na( identity_change ) ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs( x = "Sexual Identity in 2014", y = "Percentage", fill = "Missingness of Identity Change" ) +
  theme_classic()

# correlation of occupation and identity change
ggplot( d_2014_selected %>%
          filter( !is.na( identity_change ) ) %>%
          mutate( occupation = fct_na_value_to_level( occupation, level = "Missing" ),
                  identity_change = as.factor( ifelse( identity_change == 1, "Yes", "No" ) ) ),
        aes( x = occupation, fill = identity_change ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs( x = "Occupation", y = "Percentage", fill = "Identity Change" ) +
  theme_classic()

ggplot( d_2014_selected %>%
          mutate( occupation = fct_na_value_to_level( occupation, level = "Missing" ) ),
        aes( x = occupation, fill = is.na( identity_change ) ) ) +
  geom_bar( position = "fill" ) +
  scale_y_continuous( labels = scales::percent ) +
  labs( x = "Occupation", y = "Percentage", fill = "Missingness of Identity Change" ) +
  theme_classic()


### association (risk ratio) of occupation and identity change ###

# occupation and missingness of identity change
tab1 <- table( d_2014_selected$occupation, is.na( d_2014_selected$identity_change ) ) # among participants with complete occupation data
tab1

( tab1[ "Service and support", "TRUE" ] / sum( tab1[ "Service and support", ] ) ) / 
  ( tab1[ "Manual and field trades", "TRUE" ] / sum( tab1[ "Manual and field trades", ] ) ) # service and support vs manual and field trades

( tab1[ "Expertise and leadership", "TRUE" ] / sum( tab1[ "Expertise and leadership", ] ) ) / 
  ( tab1[ "Manual and field trades", "TRUE" ] / sum( tab1[ "Manual and field trades", ] ) ) # expertise and leadership vs manual and field trades

# occupation and identity change
tab2 <- table( d_2014_selected$occupation, d_2014_selected$identity_change )
tab2

( tab2[ "Service and support", "1" ] / sum( tab2[ "Service and support", ] ) ) / 
  ( tab2[ "Manual and field trades", "1" ] / sum( tab2[ "Manual and field trades", ] ) ) # service and support vs manual and field trades

( tab2[ "Expertise and leadership", "1" ] / sum( tab2[ "Expertise and leadership", ] ) ) / 
  ( tab2[ "Manual and field trades", "1" ] / sum( tab2[ "Manual and field trades", ] ) ) # expertise and leadership vs manual and field trades

# check missing data pattern
md.pattern( 
  d_2014 %>% # among all participants
    filter( !is.na( sexual_identity_2014 ) ) %>%
    select( "occupation", "sexual_identity_2021" ) %>%
    rename( ID_2021 = sexual_identity_2021 ),
  rotate.names = FALSE )

d_2014 %>%
  filter( !is.na( sexual_identity_2014 ) ) %>%
  summarise(
    prop_id2021_missing_given_occ_missing = mean( is.na( sexual_identity_2021[ is.na( occupation ) ] ) ),
    prop_occ_missing_given_id2021_missing = mean( is.na( occupation[ is.na( sexual_identity_2021 ) ] ) )
  )

md.pattern( d_2014_selected %>% # among 25-60 years
              select( "occupation", "sexual_identity_2021" ) %>%
              rename( ID_2021 = sexual_identity_2021 ),
            rotate.names = FALSE )

d_2014_selected %>%
  summarise(
    prop_id2021_missing_given_occ_missing = mean( is.na( sexual_identity_2021[ is.na( occupation ) ] ) ),
    prop_occ_missing_given_id2021_missing = mean( is.na( occupation[ is.na( sexual_identity_2021 ) ] ) )
  )
```

### 3. Complete-case analysis
```{r}
d_cc <- d_2014_selected %>% 
  select( sexual_identity_2014, identity_change ) %>%
  filter( !is.na( identity_change ) )
nrow( d_cc )
summary( d_cc )
table( d_cc$identity_change )

design <- svydesign( ids = ~ 1, data = d_cc ) # simple random sampling design
poisson_robust_model <- svyglm( identity_change ~ sexual_identity_2014,
                                design = design,
                                family = quasipoisson( link = "log" ) )

summary( poisson_robust_model )

round(
  exp( cbind( coef( poisson_robust_model )[ 2 ],
              confint( poisson_robust_model ) [ 2, , drop = FALSE ] ) ),
  2 )
```

### 4. AF4 Method
#### 4.1. Model 2
```{r}
# modeled auxiliary variable: occupation

d_af4 <- d_2014_selected %>%
  mutate(
    sex = ifelse( sex == "Female", 1, 0 ),
    Y = identity_change )

summary( d_af4 )
table( d_af4$sex )
table( d_af4$Y )
nrow( d_af4 )

set.seed( 123 )
af4_model <- af4( data = d_af4,
                  X_names = c( "sexual_identity_2014" ), 
                  X_values_1 = c( "Non-heterosexual" ),
                  X_values_2 = c( "Heterosexual" ),
                  contrast_type = "ratio",
                  Y_model = Y ~ sexual_identity_2014 + occupation,
                  W_model = list(
                    occupation ~ sexual_identity_2014 ) 
                  )
af4_model

set.seed( 123 )
get_CI( af4_model, n_boot = 1000, type = 'perc' )
```

#### 4.2. Model 3
```{r}
# modeled auxiliary variables: age, sex, country of birth

set.seed( 123 )
af4_model <- af4( data = d_af4,
                  X_names = c( "sexual_identity_2014" ), 
                  X_values_1 = c( "Non-heterosexual" ),
                  X_values_2 = c( "Heterosexual" ),
                  contrast_type = "ratio",
                  Y_model = Y ~ sexual_identity_2014 + age + sex + country_of_birth,
                  W_model = list(
                    sex ~ sexual_identity_2014,
                    age ~ sexual_identity_2014 + sex,
                    country_of_birth ~ sexual_identity_2014 + sex + age
                    ) )
af4_model

set.seed( 123 )
get_CI( af4_model, n_boot = 1000, type = 'perc' )
```

#### 4.3. Model 4
```{r}
# modeled auxiliary variables: age, sex, country of birth, occupation

set.seed( 123 )
af4_model <- af4( data = d_af4,
                  X_names = c( "sexual_identity_2014" ), 
                  X_values_1 = c( "Non-heterosexual" ),
                  X_values_2 = c( "Heterosexual" ),
                  contrast_type = "ratio",
                  Y_model = Y ~ sexual_identity_2014 + age + sex + country_of_birth + occupation,
                  W_model = list(
                    sex ~ sexual_identity_2014,
                    age ~ sexual_identity_2014 + sex,
                    country_of_birth ~ sexual_identity_2014 + sex + age,
                    occupation ~ sexual_identity_2014 + sex + age + country_of_birth
                    ) )
af4_model

set.seed( 123 )
get_CI( af4_model, n_boot = 1000, type = 'perc' )
```

### 5. MICE
#### 5.1 Model 1
```{r}
# modeled auxiliary variable: sexual identity at T1

mi_dataset <- d_2014_selected %>% 
  select( sexual_identity_2014, identity_change ) %>%
  mutate( identity_change = as.factor( 
    ifelse( identity_change == 1, "Yes", "No" ) ) )

summary( mi_dataset )
str( mi_dataset )
miss_var_summary( mi_dataset )

imp <- mice( mi_dataset, m = 70, seed = 123, print = FALSE )
summary( imp )
plot( imp )

imp_com <- complete( imp, action = "all", include = FALSE )
summary( imp_com$`1` )

imp_com <- lapply( imp_com, function( df ) {
  df %>%
    mutate( identity_change = ifelse( identity_change == "Yes", 1, 0 ) ) 
  } )
table( imp_com$`1`$identity_change )

design_imp <- svydesign( ids = ~ 1, data = imputationList( imp_com ) )

poisson_robust_model <- with( design_imp,
                              svyglm( identity_change ~ sexual_identity_2014, 
                                      family = quasipoisson( link = "log" ) ) )

pooled <- MIcombine( poisson_robust_model )
summary_result <- summary( pooled )
round(
  exp( summary_result[ 2, c( 1, 3, 4 ) ] ),
  2 )
```

#### 5.2. Model 2
```{r}
# modeled auxiliary variables: sexual identity at T1, occupation

mi_dataset <- d_2014_selected %>% 
  select( sexual_identity_2014, occupation, identity_change ) %>%
  mutate( identity_change = as.factor( 
    ifelse( identity_change == 1, "Yes", "No" ) ) )

summary( mi_dataset )
str( mi_dataset )
miss_var_summary( mi_dataset )

imp <- mice( mi_dataset, m = 70, seed = 123, print = FALSE )
summary( imp )
plot( imp )

imp_com <- complete( imp, action = "all", include = FALSE )
summary( imp_com$`1` )

imp_com <- lapply( imp_com, function( df ) {
  df %>%
    mutate( identity_change = ifelse( identity_change == "Yes", 1, 0 ) ) 
  } )
table( imp_com$`1`$identity_change )

design_imp <- svydesign( ids = ~ 1, data = imputationList( imp_com ) )

poisson_robust_model <- with( design_imp,
                              svyglm( identity_change ~ sexual_identity_2014, 
                                      family = quasipoisson( link = "log" ) ) )

pooled <- MIcombine( poisson_robust_model )
summary_result <- summary( pooled )
round(
  exp( summary_result[ 2, c( 1, 3, 4 ) ] ),
  2 )
```

#### 5.3. Model 3
```{r}
# modeled auxiliary variables: sexual identity at T1, age, sex, country of birth

mi_dataset <- d_2014_selected %>% 
  select( sexual_identity_2014, identity_change, age, sex, country_of_birth ) %>%
  mutate( identity_change = as.factor( 
    ifelse( identity_change == 1, "Yes", "No" ) ) )

summary( mi_dataset )
str( mi_dataset )
miss_var_summary( mi_dataset )

imp <- mice( mi_dataset, m = 70, seed = 123, print = FALSE )
summary( imp )
plot( imp )

imp_com <- complete( imp, action = "all", include = FALSE )
summary( imp_com$`1` )

imp_com <- lapply( imp_com, function( df ) {
  df %>%
    mutate( identity_change = ifelse( identity_change == "Yes", 1, 0 ) ) 
  } )
table( imp_com$`1`$identity_change )

design_imp <- svydesign( ids = ~ 1, data = imputationList( imp_com ) )

poisson_robust_model <- with( design_imp,
                              svyglm( identity_change ~ sexual_identity_2014, 
                                      family = quasipoisson( link = "log" ) ) )

pooled <- MIcombine( poisson_robust_model )
summary_result <- summary( pooled )
round(
  exp( summary_result[ 2, c( 1, 3, 4 ) ] ),
  2 )
```

#### 5.4. Model 4
```{r}
# modeled auxiliary variables: sexual identity at T1, age, sex, country of birth, occupation

mi_dataset <- d_2014_selected %>% 
  select( sexual_identity_2014, identity_change, age, sex, country_of_birth, occupation ) %>%
  mutate( identity_change = as.factor( 
    ifelse( identity_change == 1, "Yes", "No" ) ) )

summary( mi_dataset )
str( mi_dataset )
miss_var_summary( mi_dataset )

imp <- mice( mi_dataset, m = 70, seed = 123, print = FALSE )
summary( imp )
plot( imp )

imp_com <- complete( imp, action = "all", include = FALSE )
summary( imp_com$`1` )

imp_com <- lapply( imp_com, function( df ) {
  df %>%
    mutate( identity_change = ifelse( identity_change == "Yes", 1, 0 ) ) 
  } )
table( imp_com$`1`$identity_change )

design_imp <- svydesign( ids = ~ 1, data = imputationList( imp_com ) )

poisson_robust_model <- with( design_imp,
                              svyglm( identity_change ~ sexual_identity_2014, 
                                      family = quasipoisson( link = "log" ) ) )

pooled <- MIcombine( poisson_robust_model )
summary_result <- summary( pooled )
round(
  exp( summary_result[ 2, c( 1, 3, 4 ) ] ),
  2 )
```